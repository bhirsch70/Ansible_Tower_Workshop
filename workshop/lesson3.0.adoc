:image_links: https://s3.amazonaws.com/ansible-workshop-upmc.redhatgov.io/_images
:ansible-azure_url: https://github.com/gdykeman/ansible-azure
:vault_url: http://docs.ansible.com/ansible/playbooks_vault.html
:azure_rm_url: https://docs.ansible.com/ansible/guide_azure.html
:aws_url: https://docs.ansible.com/ansible/guide_aws.html
:vmware_url: https://www.ansible.com/vmware


= Lession 3.0 - Provisioning with Microsoft Azure

---

== Azure Provisioning Demo

---

****
This lesson is a hands-off demo, in which you can kick back and simply enjoy the show.

You're instructor is going to walk you through a few of the major components of the link:{ansible-azure_url}[ansible-azure project].
This project contains a playbook with two roles; one for deploying VMs, and one for tearing them down.


[.lead]
Section 1 - Playbook Structure

The ansible-azure playbook has a few constructs which will look familiar, and a couple which will be new.

image::pbdir_1.png[caption="Figure 1: ", title="ansible-azure project", link="{image_links}/pbdir_1.png"]

The `ansible-azure` playbook contains a single playbook, several variables files, and two roles.

[.lead]
Section 2 - Playbook Content
====
*THE PLAYBOOK* +
The playbook is called `site.yml` and it contains two roles which use tagging.  This type of tagging applies
tags to every task inside of that role.  The way in which these are used is by specifying a tag on the command line.

For example, to run this playbook and only call the `deploy` role, you would run it like this:
----
% ansible-playbook site.yml --tags "deploy"
----

[source,bash]
----
---
- hosts: localhost
  connection: local
  gather_facts: false

  roles:
    - {role: deploy, tags: ['deploy']}
    - {role: teardown, tags: ['teardown']}
----
====

====
*THE VARIBLES* +
We are defining varibles for this playbook in three places +

- *group_vars/all/vms.yml* Enables the user to define the VM hostnames which will be deployed and/or torn down +
- *group_vars/all/vars.yml* Defines default variables +
- *group_vars/all/vault.yml* Contains an password that was encrypted using Ansible Vault +

link:{vault_url{[Ansible Vault] enables you to encrypt/decrypt senstive files and passwords.

====
====
*THE ROLES*
This playbook contains two roles; `deploy` and `teardown` .  Guess what they do! +

The azure_rm* module family is used in both roles.  It includes a number of modules for managing virtual machines,
NIC, storage accounts, etc.

First, let take a look at a snippet of yaml from the `deploy` role.  This task creates the Linux VM.  This is one of
8 total tasks that are part of this role.  Technically, we could have used just this one task and allowed
the Azure to create default services for the `resource group`, `storage account`, etc.  However, we wanted to control
the specifics of those services.


[source,bash]
----
- name: Create VM
  azure_rm_virtualmachine:
    resource_group: "{{ resource }}"
    name: "{{ item }}"
    vm_size: "{{ vmsize }}"
    admin_username: "{{ username }}"
    admin_password: "{{ password }}"
    image:
     offer: CentOS
     publisher: OpenLogic
     sku: '7.2'
     version: latest
  with_items:
    - "{{ vmname }}"
----
====

Next, we'll show you one of the tasks from the `teardown` role.  Essentially, it uses the same tasks from the `deploy` role, but
in reverse and with one, very distinct difference; all tasks include `state: absent`.  Here is the task which removes the NIC.

[source,bash]
----
- name: Delete network interface using existing security group and public IP
  azure_rm_networkinterface:
        name: "{{ item }}-nic"
        resource_group: "{{ resource }}"
        state: absent
  with_items:
     - "{{ vmname }}"
----
====

[.lead]
Section 3: Review

Although this lesson was hands off, it demonstrates just how powerful, yet still simple it is to provision systems using
Ansible.  Case in point; the Amazon instances you've been using all day were created last night using an Ansible playbook.
There is a lot of good work out there on public/private cloud provisioning using Ansible, so we encourage you to check it out.

link:{ansible-azure_url}[Getting Started with Ansible Azure] +
link:{aws_url}[Amazon Web Services Guide] +
link:{vmware_url}[Ansible and VMware]
